# Import and authenticate
Connect-ExchangeOnline

# Specify the date ranges (run on a monday morning)
$Start = (Get-Date).AddDays(-7).ToString("yyyy-MM-dd")
$End = (Get-Date).ToString("yyyy-MM-dd")
$WeekEnd = (Get-Date).AddDays(-1).ToString("yyyy-MM-dd")

# Specify address/es to search
$Addresses = @(
"test@test.com",
"test2@test.com"
)

# Empty catch-all array
$OutputData = @()

# Create and define export paths
$NewWeekFolder = New-Item -Path "C:\Temp\MailFlowCounting\Week_Ending_$WeekEnd" -ItemType Directory

# Loop through each address and collect all mail
ForEach ($Address in $Addresses)
    {
    $MailboxName = ($address -split "@")[0]
    $NewMailboxFolder = New-Item -Path (Join-Path $NewWeekFolder $MailboxName) -ItemType Directory -Force
        
    # Specify output CSV path
    $OutputRecieved = "$NewMailboxFolder\MailFlow-Recieved-$MailboxName-Week-Ending-$WeekEnd.csv"
    $OutputSent = "$NewMailboxFolder\MailFlow-Sent-$MailboxName-Week-Ending-$WeekEnd.csv"

    # Get all mail in both directions
    $MailRecieved = Get-MessageTraceV2 -RecipientAddress $Address -StartDate $Start -EndDate $End
    $MailSent = Get-MessageTraceV2 -SenderAddress $Address -StartDate $Start -EndDate $End
    
    $MailRecieved | Select-Object Received,SenderAddress,RecipientAddress,Status,Subject | Export-Csv $OutputRecieved -NoTypeInformation
    $MailSent | Select-Object Received,SenderAddress,RecipientAddress,Status,Subject | Export-Csv $OutputSent -NoTypeInformation

    # Count of all mail in each direction
    $TotalRecieved = $MailRecieved.Count
    $TotalSent = $MailSent.Count

    # Build CSV data
    $OutputData += New-Object PSObject -Property @{
        Total_Sent              = $TotalSent
        Total_Received          = $TotalRecieved
        Total_Mail              = $TotalRecieved + $TotalSent
        Mailbox                 = $Address
        Start_Date              = $Start
        End_Date                = $WeekEnd
        }
}

$OutputData | Export-CSV -Path "$NewWeekFolder\MailFlow-Stats-Week-Ending-$WeekEnd.csv"


